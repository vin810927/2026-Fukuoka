<!--
  ä¹å·è³æ«»è‡ªé§• 2026ï½œå–®æª”è¡Œç¨‹ Web App
  Version: v0.4.3
  Updated: 2026-01-08 (Asia/Taipei)
  Tech: Tailwind CDN + Vue 3 (global build) + Open-Meteo
  Notes:
  - æ”¯æ´ï¼šå…§å®¹å¯ç·¨è¼¯ï¼ˆcontenteditableï¼‰ï¼‹ localStorage è‡ªå‹•ä¿å­˜
  - æ”¯æ´ï¼šOpen-Meteo 5 æ—¥é å ±ï¼ˆä¾æ¯æ—¥ base åº§æ¨™ï¼‰
  - æ”¯æ´ï¼šé¤å»³å€å¡Šï¼ˆTabelog åˆ†æ•¸ / è¨‚ä½é€£çµï¼‰
  - æ”¯æ´ï¼šåˆ†äº«ï¼ˆURL Hash å£“ç¸® JSONï¼‰
  - æ”¯æ´ï¼šåŸå¸‚é è¦½ï¼ˆOSM tile 2Ã—2 ç¸®åœ– + Maps/OSM é€£çµï¼‰
  - é˜²å‘†ï¼šv-cloak + bootMsgï¼ˆé¿å… Vue æœªå•Ÿå‹•æ™‚ç•«é¢å´©å£ï¼‰
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¹å·è³æ«»è‡ªé§• 2026ï½œè¡Œç¨‹è¡¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: [
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "Segoe UI",
              "Noto Sans TC",
              "Noto Sans JP",
              "Hiragino Sans",
              "Arial"
            ]
          },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.08)" }
        }
      }
    }
  </script>
  <style>
    :root{ color-scheme: light; }
    [v-cloak]{ display:none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .editable[contenteditable="true"]{ outline: 2px dashed rgba(120,113,108,0.35); outline-offset: 6px; border-radius: 14px; }
    .editable[contenteditable="true"]:focus{ outline-color: rgba(120,113,108,0.7); }
    .tap{ min-height:44px; }
  </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans">
  <!-- å¦‚æœ Vue/JS æ²’æˆåŠŸå•Ÿå‹•ï¼Œè‡³å°‘ä¸è¦æ•´é ç‚¸è£‚ -->
  <div id="bootMsg" class="max-w-3xl mx-auto px-4 py-6">
    <div class="rounded-2xl border border-stone-200 bg-white shadow-soft p-4">
      <div class="text-sm font-semibold">è¼‰å…¥ä¸­â€¦</div>
      <div class="mt-1 text-xs text-stone-600">è‹¥ 3 ç§’å¾Œä»åœåœ¨é€™è£¡ï¼Œè«‹é‡æ–°æ•´ç†ï¼›æˆ–æª¢æŸ¥ç¶²è·¯æ˜¯å¦èƒ½è¼‰å…¥ unpkg / CDNã€‚</div>
    </div>
  </div>

  <div id="app" v-cloak class="min-h-screen">
    <!-- Top bar -->
    <header class="sticky top-0 z-30 bg-stone-50/85 backdrop-blur border-b border-stone-200">
      <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="flex-1">
          <div class="text-xs text-stone-500">{{ plan.meta.tripCode }}</div>
          <div class="text-lg font-semibold leading-tight editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.title')">{{ plan.meta.title }}</div>
        </div>
        <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="toggleEdit">ç·¨è¼¯ï¼š<span class="font-semibold">{{ editMode ? 'é–‹' : 'é—œ' }}</span></button>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-4 pb-28">
      <!-- Meta cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="text-xs text-stone-500">æ—¥æœŸ</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.dateRange')">{{ plan.meta.dateRange }}</div>
          <div class="mt-2 text-xs text-stone-500">äººæ•¸</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.party')">{{ plan.meta.party }}</div>
        </div>
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="text-xs text-stone-500">äº¤é€š</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.mobility')">{{ plan.meta.mobility }}</div>
          <div class="mt-2 text-xs text-stone-500">æ”å½±</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.gear')">{{ plan.meta.gear }}</div>
        </div>
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="text-xs text-stone-500">å®Œæˆåº¦</div>
              <div class="mt-1 flex items-center gap-2">
                <div class="w-full h-2 rounded-full bg-stone-200 overflow-hidden">
                  <div class="h-full bg-stone-700" :style="{width: progressPct + '%'}"></div>
                </div>
                <div class="text-xs text-stone-600 tabular-nums">{{ doneCount }}/{{ totalStops }}</div>
              </div>
              <div class="mt-2 text-xs text-stone-500">é ç®—ï¼ˆç²—ä¼°ï¼‰</div>
              <div class="mt-1 text-sm text-stone-700">
                <span class="tabular-nums">Â¥{{ totalJPY.toLocaleString() }}</span>
                <span class="text-stone-400"> / </span>
                <span class="tabular-nums">NT$ {{ totalTWD.toLocaleString() }}</span>
              </div>
            </div>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="resetDone">æ¸…é™¤å®Œæˆ</button>
          </div>
        </div>
      </section>

      <!-- Key tasks -->
      <section class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">é—œéµä»»å‹™</div>
            <div class="text-xs text-stone-500">è¡Œç¨‹å¤–çš„æ¶ç¥¨/æ¶é ç´„ï¼Œæ”¾é€™è£¡æ¯”è¼ƒä¸æœƒå¿˜ã€‚</div>
          </div>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="addTask">ï¼‹ æ–°å¢</button>
        </div>
        <div class="mt-3 space-y-2">
          <div v-for="(t, ti) in plan.tasks" :key="t.id" class="flex items-start gap-3 p-3 rounded-2xl border border-stone-200 bg-stone-50">
            <input type="checkbox" class="mt-1 h-5 w-5 accent-stone-700" :checked="isDone('task', t.id)" @change="toggleDone('task', t.id)" />
            <div class="flex-1">
              <div class="text-sm font-medium editable" :contenteditable="editMode" @blur="onBlurText($event, `tasks.${ti}.title`)">{{ t.title }}</div>
              <div class="mt-1 text-xs text-stone-600 editable whitespace-pre-wrap" :contenteditable="editMode" @blur="onBlurText($event, `tasks.${ti}.note`)">{{ t.note }}</div>
            </div>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="deleteTask(ti)">åˆªé™¤</button>
          </div>
        </div>
      </section>

      <!-- Weather -->
      <section id="weather" class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">å¤©æ°£ï¼ˆ5æ—¥ï¼‰</div>
            <div class="text-xs text-stone-500">è³‡æ–™ä¾†æºï¼šOpen-Meteoã€‚ä¾ã€Œç•¶å¤© base åº§æ¨™ã€å–å€¼ã€‚</div>
          </div>
          <div class="flex items-center gap-2">
            <select class="tap text-sm rounded-xl border border-stone-300 bg-white px-3 py-2" v-model.number="weatherDayIndex" @change="onWeatherDayChange">
              <option v-for="(d, i) in plan.days" :key="d.id" :value="i">{{ d.dayLabel }} Â· {{ d.area }}</option>
            </select>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="refreshWeather">æ›´æ–°</button>
          </div>
        </div>

        <!-- City preview -->
        <div class="mt-3 rounded-2xl border border-stone-200 bg-stone-50 p-3">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-stone-500">åŸå¸‚é è¦½ï¼ˆä¾é¸å– Day çš„ Baseï¼‰</div>
              <div class="mt-1 text-sm font-semibold truncate">{{ selectedDay.area }} Â· {{ selectedDay.base?.name }}</div>
              <div class="mt-1 text-xs text-stone-600 tabular-nums" v-if="hasCoords">
                {{ Number(selectedDay.base?.lat).toFixed(5) }}, {{ Number(selectedDay.base?.lon).toFixed(5) }}
              </div>
            </div>
            <div class="flex items-center gap-2" v-if="hasCoords">
              <a class="tap shrink-0 inline-flex items-center px-3 py-2 rounded-xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700"
                :href="googleMapsLatLonUrl(selectedDay.base.lat, selectedDay.base.lon)" target="_blank" rel="noreferrer">Google Maps</a>
              <a class="tap shrink-0 inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50"
                :href="openStreetMapUrl(selectedDay.base.lat, selectedDay.base.lon, 12)" target="_blank" rel="noreferrer">OSM</a>
            </div>
          </div>
          <div class="mt-3">
            <div v-if="hasCoords" class="relative">
              <div v-if="!mapTileError" class="grid grid-cols-2 overflow-hidden rounded-2xl border border-stone-200 bg-white">
                <img v-for="u in mapTileUrls" :key="u" :src="u" class="w-full h-[80px] object-cover" loading="lazy" @error="mapTileError=true" alt="osm tile" />
              </div>
              <div v-else class="w-full h-[160px] rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-sm text-stone-500">
                ç¸®åœ–è¼‰å…¥å¤±æ•—ï¼ˆæ­¤é è¦½ç’°å¢ƒå¯èƒ½æ“‹å¤–éƒ¨åœ–ç‰‡ï¼‰ã€‚
              </div>
              <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
                <div class="w-3 h-3 rounded-full bg-rose-600/80 ring-2 ring-white"></div>
              </div>
            </div>
            <div v-else class="w-full h-[160px] rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-sm text-stone-500">ç„¡åº§æ¨™ï¼ˆè«‹è£œä¸Š base.lat / base.lonï¼‰</div>
          </div>
        </div>

        <div class="mt-3">
          <div v-if="weather.loading" class="text-sm text-stone-600">è®€å–ä¸­â€¦</div>
          <div v-else-if="weather.error" class="text-sm text-rose-700">{{ weather.error }}</div>
          <div v-else class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <div v-for="(w, wi) in weather.items" :key="wi" class="p-3 rounded-2xl border border-stone-200 bg-stone-50">
              <div class="text-xs text-stone-500">{{ w.date }}</div>
              <div class="mt-1 text-sm font-medium">{{ w.text }}</div>
              <div class="mt-2 text-xs text-stone-600 tabular-nums">H {{ w.tmax }}Â° / L {{ w.tmin }}Â°</div>
              <div class="mt-1 text-xs text-stone-600">é™é›¨ {{ w.precip }} mm</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Notes -->
      <section class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="text-sm font-semibold">å‚™å¿˜</div>
        <div class="mt-2 text-sm text-stone-700 whitespace-pre-wrap editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.notes')">{{ plan.meta.notes }}</div>
      </section>

      <!-- Days -->
      <section class="mt-4 space-y-3">
        <div v-for="(day, di) in plan.days" :key="day.id" :id="`day-${di+1}`" class="bg-white rounded-2xl shadow-soft border border-stone-200 overflow-hidden">
          <div class="p-4 border-b border-stone-200">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <div class="text-xs text-stone-500">{{ day.date }}</div>
                <div class="text-base font-semibold editable" :contenteditable="editMode" @blur="onBlurText($event, `days.${di}.title`)">{{ day.dayLabel }}ï¼š{{ day.title }}</div>
                <div class="mt-1 text-sm text-stone-600 editable" :contenteditable="editMode" @blur="onBlurText($event, `days.${di}.summary`)">{{ day.summary }}</div>
              </div>
              <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="openGoogleMapsDay(day)">Maps</button>
            </div>

            <div class="mt-3 flex flex-wrap gap-2 text-xs">
              <span class="px-2 py-1 rounded-full bg-stone-100 border border-stone-200">Baseï¼š{{ day.base.name }}</span>
              <span class="px-2 py-1 rounded-full bg-stone-100 border border-stone-200">Areaï¼š{{ day.area }}</span>
              <span v-if="day.driveHint" class="px-2 py-1 rounded-full bg-stone-100 border border-stone-200">Driveï¼š{{ day.driveHint }}</span>
            </div>
          </div>

          <div class="p-4 space-y-3">
            <div v-for="(stop, si) in day.stops" :key="stop.id" class="rounded-2xl border border-stone-200 bg-stone-50 p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" class="mt-1 h-5 w-5 accent-stone-700" :checked="isDone(day.id, stop.id)" @change="toggleDone(day.id, stop.id)" />

                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs text-stone-500 tabular-nums" v-if="stop.time">{{ stop.time }}</span>
                    <span class="text-xs px-2 py-1 rounded-full border" :class="levelBadge(stop.level)">{{ levelText(stop.level) }}</span>
                    <span class="text-xs px-2 py-1 rounded-full border" :class="kindBadge(stop.kind)">{{ kindText(stop.kind) }}</span>
                    <span v-if="stop.bestShot" class="text-xs px-2 py-1 rounded-full border border-stone-300 bg-white">æ‹æ”ï¼š{{ stop.bestShot }}</span>
                  </div>

                  <div class="mt-2 text-sm font-semibold editable" :contenteditable="editMode" @blur="onBlurText($event, `days.${di}.stops.${si}.title`)">{{ stop.title }}</div>
                  <div v-if="stop.titleLocal" class="mt-1 text-xs text-stone-600 editable" :contenteditable="editMode" @blur="onBlurText($event, `days.${di}.stops.${si}.titleLocal`)">{{ stop.titleLocal }}</div>

                  <div class="mt-2 text-sm text-stone-700 whitespace-pre-wrap editable" :contenteditable="editMode" @blur="onBlurText($event, `days.${di}.stops.${si}.desc`)">{{ stop.desc }}</div>

                  <div v-if="stop.lens" class="mt-2 text-xs text-stone-600 whitespace-pre-wrap">ğŸ“· {{ stop.lens }}</div>

                  <!-- Food block -->
                  <div v-if="stop.kind==='food'" class="mt-3 rounded-2xl border border-stone-200 bg-white p-3">
                    <div class="flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-xs text-stone-500">é¤å»³</div>
                        <div class="text-sm font-semibold truncate">{{ stop.food?.name }}</div>
                        <div class="text-xs text-stone-600" v-if="stop.food?.nameLocal">{{ stop.food?.nameLocal }}</div>
                        <div class="mt-1 text-xs text-stone-600" v-if="stop.food?.tabelogScore">Tabelogï¼š<span class="font-semibold tabular-nums">{{ stop.food?.tabelogScore }}</span></div>
                      </div>
                      <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-stone-50 text-sm hover:bg-stone-100" @click="openFoodEditor(di, si)">ç·¨è¼¯é¤å»³è³‡è¨Š</button>
                    </div>

                    <div class="mt-3 flex flex-wrap gap-2">
                      <a v-if="stop.food?.tabelogUrl" class="tap inline-flex items-center px-3 py-2 rounded-xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" :href="stop.food?.tabelogUrl" target="_blank" rel="noreferrer">é£Ÿã¹ãƒ­ã‚°</a>
                      <a v-if="stop.food?.reserve?.tablecheck" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="stop.food?.reserve?.tablecheck" target="_blank" rel="noreferrer">TableCheck è¨‚ä½</a>
                      <a v-if="stop.food?.reserve?.hotpepper" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="stop.food?.reserve?.hotpepper" target="_blank" rel="noreferrer">HotPepper è¨‚ä½</a>
                      <a v-if="stop.food?.reserve?.omakase" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="stop.food?.reserve?.omakase" target="_blank" rel="noreferrer">Omakase è¨‚ä½</a>
                      <a v-if="stop.food?.reserve?.official" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="stop.food?.reserve?.official" target="_blank" rel="noreferrer">å®˜æ–¹/åº—å®¶</a>
                    </div>

                    <div v-if="stop.food?.note" class="mt-2 text-xs text-stone-600 whitespace-pre-wrap">{{ stop.food?.note }}</div>
                  </div>

                  <!-- Links -->
                  <div class="mt-3 flex flex-wrap gap-2">
                    <a v-if="stop.mapsQuery" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="mapsSearchUrl(stop.mapsQuery)" target="_blank" rel="noreferrer">Google Maps</a>
                    <a v-for="(lk, li) in (stop.links||[])" :key="li" class="tap inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="lk.url" target="_blank" rel="noreferrer">{{ lk.label }}</a>
                  </div>

                  <div class="mt-3 text-xs text-stone-600 flex flex-wrap gap-x-4 gap-y-1">
                    <span v-if="stop.stayMins" class="tabular-nums">åœç•™ï¼š{{ stop.stayMins }} min</span>
                    <span v-if="stop.costJPY" class="tabular-nums">è²»ç”¨ï¼šÂ¥{{ Number(stop.costJPY).toLocaleString() }}</span>
                  </div>
                </div>

                <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="openStopMenu(di, si)">â‹¯</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tools -->
      <section class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="text-sm font-semibold">å·¥å…·</div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="openJson('export')">åŒ¯å‡º JSON</button>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="openJson('import')">åŒ¯å…¥ JSON</button>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="copyShare">è¤‡è£½åˆ†äº«é€£çµ</button>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="resetPlan">é‡ç½®ï¼ˆå›åˆ°é è¨­ï¼‰</button>
        </div>
        <div class="mt-2 text-xs text-stone-500">æé†’ï¼šæ­¤æª”æ¡ˆå¯é›¢ç·šä½¿ç”¨ï¼›è‹¥è¦ã€Œç·šä¸Šé è¦½/åˆ†äº«ã€ï¼Œå¯å°‡æ­¤ HTML æ”¾åˆ° GitHub Pages / Netlify / Vercelï¼ˆéœæ…‹ç«™ï¼‰ã€‚</div>
      </section>

      <div class="h-8"></div>
    </main>

    <!-- Bottom nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-40 border-t border-stone-200 bg-stone-50/90 backdrop-blur">
      <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-2 overflow-x-auto no-scrollbar">
        <a class="tap shrink-0 px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" href="#weather">å¤©æ°£</a>
        <a v-for="(d, i) in plan.days" :key="d.id" class="tap shrink-0 px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="`#day-${i+1}`">Day {{ i+1 }}</a>
        <button class="tap shrink-0 ml-auto px-3 py-2 rounded-xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="scrollTop">å›é ‚éƒ¨</button>
      </div>
    </nav>

    <!-- Food editor modal -->
    <div v-if="modals.food.open" class="fixed inset-0 z-50 flex items-end md:items-center justify-center">
      <div class="absolute inset-0 bg-black/25" @click="closeFoodEditor"></div>
      <div class="relative w-full md:max-w-xl bg-white rounded-t-3xl md:rounded-3xl shadow-soft border border-stone-200 p-4 md:p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">é¤å»³è³‡è¨Š</div>
            <div class="text-xs text-stone-500">æœƒå¯«å…¥æœ¬åœ°å„²å­˜èˆ‡åˆ†äº«é€£çµã€‚</div>
          </div>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="closeFoodEditor">é—œé–‰</button>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-3">
          <label class="text-xs text-stone-600">é¤å»³åç¨±</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.name" />

          <label class="text-xs text-stone-600">é¤å»³åç¨±ï¼ˆæ—¥æ–‡/åŸæ–‡ï¼‰</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.nameLocal" />

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-stone-600">Tabelog åˆ†æ•¸</label>
              <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.tabelogScore" placeholder="ä¾‹ï¼š3.72" />
            </div>
            <div>
              <label class="text-xs text-stone-600">Tabelog é€£çµ</label>
              <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.tabelogUrl" placeholder="https://tabelog.com/..." />
            </div>
          </div>

          <label class="text-xs text-stone-600">TableCheck</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.reserve.tablecheck" placeholder="https://www.tablecheck.com/..." />

          <label class="text-xs text-stone-600">HotPepper</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.reserve.hotpepper" placeholder="https://www.hotpepper.jp/..." />

          <label class="text-xs text-stone-600">Omakase</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.reserve.omakase" placeholder="https://omakase.in/..." />

          <label class="text-xs text-stone-600">å®˜æ–¹/åº—å®¶</label>
          <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="foodForm.reserve.official" placeholder="https://..." />

          <label class="text-xs text-stone-600">å‚™è¨»</label>
          <textarea class="w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" rows="3" v-model="foodForm.note" placeholder="ä¾‹ï¼šéœ€è¦æ’éšŠ/ä¸æ¥å—é›»è©±é ç´„/å»ºè­° 18:00 å‰åˆ°â€¦"></textarea>

          <button class="tap w-full px-3 py-3 rounded-2xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="saveFood">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- JSON modal -->
    <div v-if="modals.json.open" class="fixed inset-0 z-50 flex items-end md:items-center justify-center">
      <div class="absolute inset-0 bg-black/25" @click="closeJson"></div>
      <div class="relative w-full md:max-w-2xl bg-white rounded-t-3xl md:rounded-3xl shadow-soft border border-stone-200 p-4 md:p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">{{ modals.json.mode==='export' ? 'åŒ¯å‡º JSON' : 'åŒ¯å…¥ JSON' }}</div>
            <div class="text-xs text-stone-500">å¯ç”¨ä¾†æ¬ç§»/å‚™ä»½è¡Œç¨‹è³‡æ–™ã€‚</div>
          </div>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="closeJson">é—œé–‰</button>
        </div>
        <textarea class="mt-3 w-full rounded-2xl border border-stone-300 bg-stone-50 p-3 text-xs font-mono" rows="12" v-model="modals.json.text"></textarea>
        <div class="mt-3 flex gap-2">
          <button v-if="modals.json.mode==='export'" class="tap flex-1 px-3 py-3 rounded-2xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="copyText(modals.json.text)">è¤‡è£½</button>
          <button v-else class="tap flex-1 px-3 py-3 rounded-2xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="importJson">åŒ¯å…¥ä¸¦è¦†è“‹</button>
        </div>
      </div>
    </div>

    <!-- Stop menu modal -->
    <div v-if="modals.stop.open" class="fixed inset-0 z-50 flex items-end md:items-center justify-center">
      <div class="absolute inset-0 bg-black/25" @click="closeStopMenu"></div>
      <div class="relative w-full md:max-w-lg bg-white rounded-t-3xl md:rounded-3xl shadow-soft border border-stone-200 p-4 md:p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">é …ç›®è¨­å®š</div>
            <div class="text-xs text-stone-500">èª¿æ•´ç­‰ç´š/é¡å‹èˆ‡å°é‡æ•¸å€¼ã€‚</div>
          </div>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" @click="closeStopMenu">é—œé–‰</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-stone-600">ç­‰ç´š</label>
            <select class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="stopMenu.level">
              <option value="must">å¿…å»</option>
              <option value="flex">å¯èª¿æ•´</option>
              <option value="backup">å‚™æ¡ˆ</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-stone-600">é¡å‹</label>
            <select class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="stopMenu.kind">
              <option value="spot">æ™¯é»</option>
              <option value="food">é¤å»³</option>
              <option value="hotel">ä½å®¿</option>
              <option value="drive">è‡ªé§•/ç§»å‹•</option>
              <option value="task">ä»»å‹™</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-stone-600">åœç•™ï¼ˆminï¼‰</label>
            <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="stopMenu.stayMins" placeholder="60" />
          </div>
          <div>
            <label class="text-xs text-stone-600">è²»ç”¨ï¼ˆJPYï¼‰</label>
            <input class="tap w-full rounded-xl border border-stone-300 bg-stone-50 px-3 py-2 text-sm" v-model="stopMenu.costJPY" placeholder="800" />
          </div>
        </div>

        <button class="tap mt-4 w-full px-3 py-3 rounded-2xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="applyStopMenu">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    'use strict';

    const { createApp } = Vue;

    const EXCHANGE_RATE = 4.6; // ç²—ç•¥æ›ç®—ï¼Œå¯è‡ªè¡Œæ”¹
    const LS_KEY = 'kyushu_sakura_2026_plan_v1';
    const LS_DONE_KEY = 'kyushu_sakura_2026_done_v1';

    const defaultPlan = {
      meta: {
        tripCode: 'KYUSHU-SAKURA-2026',
        title: '2026 ä¹å·è³æ«»è‡ªé§•ï½œDr. Huang & å¤ªå¤ª',
        dateRange: '2026/03/25 (ä¸‰) - 2026/03/28 (å…­) Â· 4å¤©3å¤œ',
        party: '2 äººï¼ˆç„¡é•·è¼©/å°å­©ï¼‰',
        mobility: 'BR106 æŠµé” FUK 11:15ï½œè‡ªé§•ï¼ˆSUVï¼‰ï½œç¦å²¡ç©ºæ¸¯å–é‚„è»Šï½œæ™šç­å›å°',
        gear: 'Sony A7CRï¼š35mm / 24-70mmï½œFUJIFILM X-T5ï¼š16-300mm',
        notes:
`ä½å®¿æ›´æ–°ï¼š
- 3/25â€“3/27ï¼šæ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡ (KAI Aso) 2æ™š
- 3/27ï¼šç¦å²¡å¸‚å€ï¼ˆåšå¤šï¼‰1æ™š

é—œéµæé†’ï¼š
- é«˜åƒç©‚å³¡ è²¸ã—ãƒœãƒ¼ãƒˆï¼šä¹˜èˆ¹æ—¥ 2 é€±å‰ 09:00ï¼ˆJSTï¼‰é–‹æ”¾ï¼ˆè‹¥ 3/27 ä¹˜èˆ¹ â†’ 3/13 09:00 æ¶ï¼‰ã€‚
- å¤ªå®°åºœï¼šå»ºè­°æ—©ä¸Šå»ï¼Œé¿é–‹åƒé“äººæ½®ã€‚
- è‡ªé§•ï¼šå±±è·¯/é«˜é€Ÿè«‹ä¿ç•™ 15â€“25% ç·©è¡ã€‚
`,
      },
      tasks: [
        {
          id: 'task-takachiho-boat',
          title: 'é«˜åƒç©‚å³¡ è²¸ã—ãƒœãƒ¼ãƒˆï¼šæ¶é ç´„',
          note:
`ä¹˜èˆ¹æ—¥ 2 é€±å‰ 09:00ï¼ˆJSTï¼‰é–‹æ”¾ã€‚
é ç´„ç¶²å€ï¼šhttps://eipro.jp/takachiho1/eventCalendars/index
ï¼ˆå»ºè­°ï¼š3/13 08:55 è¨­æé†’ï¼Œ09:00 ç›´æ¥é€å‡ºï¼‰`
        }
      ],
      days: [
        {
          id: 'day1',
          dayLabel: 'Day 1',
          date: '2026/03/25ï¼ˆä¸‰ï¼‰',
          area: 'ç¦å²¡ (Fukuoka) â†’ é˜¿è˜‡ (Aso)',
          title: 'è½åœ°å³å…¥ç•Œ Â· ç·©è¡å„ªå…ˆ',
          summary: 'æŠµé”å¾Œå…ˆå–è»Šä¸Šé˜¿è˜‡ï¼›ä¸‹åˆä»¥æº–æ™‚å…¥ä½ç‚ºç¬¬ä¸€å„ªå…ˆã€‚',
          driveHint: 'FUK â†’ ç•Œ é˜¿è˜‡ï¼ˆé•·è·é›¢ï¼‰',
          base: { name: 'æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡ (KAI Aso)', lat: 33.08069, lon: 131.193505 },
          stops: [
            {
              id: 'd1-arrival',
              time: '11:15',
              kind: 'drive',
              level: 'must',
              title: 'æŠµé”ï¼šç¦å²¡æ©Ÿå ´ (FUK)',
              titleLocal: 'ç¦å²¡ç©ºæ¸¯',
              desc: 'å…¥å¢ƒ/å–è¡Œæå¾Œï¼Œç›´æ¥å‰å¾€ç§Ÿè»Šæ«ƒå°ï¼ˆå»ºè­°ç¦å²¡ç©ºæ¸¯å–è»Šï¼‰ã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'Fukuoka Airport',
              links: [],
              stayMins: 60,
              costJPY: 0,
            },
            {
              id: 'd1-car',
              time: '12:30',
              kind: 'drive',
              level: 'must',
              title: 'å–è»Šï¼šç¦å²¡ç©ºæ¸¯ Rent-a-Car',
              titleLocal: 'ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ï¼ˆç¦å²¡ç©ºæ¸¯ï¼‰',
              desc: 'ç¢ºèª KEP+ETCã€è»Šæ³èˆ‡æ‹ç…§ç´€éŒ„ã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'ç¦å²¡ç©ºæ¸¯ ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼',
              links: [],
              stayMins: 40,
              costJPY: 0,
            },
            {
              id: 'd1-drive',
              time: '13:30',
              kind: 'drive',
              level: 'must',
              title: 'ç§»å‹•ï¼šç¦å²¡ â†’ ç•Œ é˜¿è˜‡',
              titleLocal: '',
              desc: 'é«˜é€Ÿï¼‹å±±è·¯ï¼Œé ç•™ä¼‘æ¯ç«™ã€‚è‹¥å¡è»Šï¼Œå…ˆç¢ºä¿å…¥ä½ä¸å»¶èª¤ã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡',
              links: [],
              stayMins: 210,
              costJPY: 0,
            },
            {
              id: 'd1-kaiaso',
              time: '17:00',
              kind: 'hotel',
              level: 'must',
              title: 'å…¥ä½ï¼šæ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡ (KAI Aso)',
              titleLocal: 'æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡',
              desc: 'å…¥ä½å¾Œä»¥æˆ¿å…§éœ²å¤©é¢¨å‘‚/åœ’å€æ•£æ­¥æ”¶å°¾ã€‚',
              bestShot: 'æ˜/å¤œ',
              lens: 'å®¤å…§ï¼š35mmï¼›åº­åœ’å±¤æ¬¡ 50â€“70mmã€‚',
              mapsQuery: 'æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡',
              links: [
                { label: 'å®˜æ–¹', url: 'https://hoshinoresorts.com/ja/hotels/kaiaso/' },
                { label: 'äº¤é€š', url: 'https://hoshinoresorts.com/ja/hotels/kaiaso/access/' }
              ],
              stayMins: 60,
              costJPY: 0,
            },
          ]
        },
        {
          id: 'day2',
          dayLabel: 'Day 2',
          date: '2026/03/26ï¼ˆå››ï¼‰',
          area: 'é˜¿è˜‡ (Aso)',
          title: 'ç«å±±åœ°æ™¯ Â· ä½é£½å’Œåº¦ä¸»å ´',
          summary: 'ä»¥è‰åƒé‡Œ/å¤§è§€å³°ç‚ºä¸»ï¼Œå¤©å€™ä¸ä½³å°±æ”¹å®¤å…§/å’–å•¡ï¼Œé¿å…ç¡¬æ‹šã€‚',
          driveHint: 'é˜¿è˜‡å‘¨é‚Š',
          base: { name: 'æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ ç•Œ é˜¿è˜‡ (KAI Aso)', lat: 33.08069, lon: 131.193505 },
          stops: [
            {
              id: 'd2-kusasenri',
              time: '08:30',
              kind: 'spot',
              level: 'must',
              title: 'è‰åƒé‡Œãƒ¶æµœ (Kusasenri-ga-hama)',
              titleLocal: 'è‰åƒé‡Œãƒ¶æµœ',
              desc: 'ç«å±±åœ°æ™¯çš„ä½é£½å’Œåº¦ä¸»å ´ã€‚é¢¨å¤§æ³¨æ„ç°å¡µèˆ‡é¡é ­ä¿è­·ã€‚',
              bestShot: 'æ™¨',
              lens: '24mm æ‹ä¸­å²³ï¼‹è‰åŸï¼›70mm å£“ç¸®åœ°å½¢èˆ‡é¦¬åŒ¹ã€‚',
              mapsQuery: 'è‰åƒé‡Œãƒ¶æµœ',
              links: [],
              stayMins: 70,
              costJPY: 0,
            },
            {
              id: 'd2-daikanbo',
              time: '10:30',
              kind: 'spot',
              level: 'flex',
              title: 'å¤§è¦³å³° (Daikanbo)',
              titleLocal: 'å¤§è¦³å³°',
              desc: 'è¦–é‡é»ã€‚è‹¥é›²éœ§åšå¯ç›´æ¥ç•¥éï¼Œç•™é«”åŠ›ã€‚',
              bestShot: 'åˆå‰',
              lens: '24â€“35mm å–æ™¯ï¼›70mm å£“ç¸®å±±ç¨œã€‚',
              mapsQuery: 'å¤§è¦³å³°',
              links: [],
              stayMins: 45,
              costJPY: 0,
            },
            {
              id: 'd2-onsen',
              time: '15:30',
              kind: 'spot',
              level: 'must',
              title: 'ç•Œ é˜¿è˜‡ï¼šç§äººéœ²å¤©é¢¨å‘‚/åœ’å€æ•£æ­¥',
              titleLocal: '',
              desc: 'åˆå¾Œå›å®¿æ”¾ç©ºï¼Œé€™å¤©ä¸å¡å¤ªå¤šé»ã€‚',
              bestShot: 'æ˜/å¤œ',
              lens: '35mm éš¨æ‹å³å¯ã€‚',
              mapsQuery: '',
              links: [],
              stayMins: 120,
              costJPY: 0,
            },
          ]
        },
        {
          id: 'day3',
          dayLabel: 'Day 3',
          date: '2026/03/27ï¼ˆäº”ï¼‰',
          area: 'é˜¿è˜‡ â†’ é«˜åƒç©— â†’ åšå¤š',
          title: 'ç¥è©±å³½è°· Â· æ™šå›ç¦å²¡',
          summary: 'ä¸­åˆå‰å¾Œé€²é«˜åƒç©—ï¼Œåˆ’èˆ¹æ˜¯é‡é»ï¼›å‚æ™šå›åšå¤šä½ä¸€æ™šã€‚',
          driveHint: 'é•·è·é›¢ï¼ˆå‹™å¿…ä¿ç•™ç·©è¡ï¼‰',
          base: { name: 'éƒ½ãƒ›ãƒ†ãƒ« åšå¤š (Miyako Hotel Hakata)', lat: 33.5896534, lon: 130.4228213 },
          stops: [
            {
              id: 'd3-depart',
              time: '08:30',
              kind: 'drive',
              level: 'must',
              title: 'é€€æˆ¿ï¼šç•Œ é˜¿è˜‡ â†’ é«˜åƒç©—',
              titleLocal: '',
              desc: 'å…ˆæŠŠç§»å‹•åšå®Œï¼Œé ç•™åœè»Šèˆ‡æ’éšŠç·©è¡ã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'é«˜åƒç©‚å³¡ è²¸ã—ãƒœãƒ¼ãƒˆ',
              links: [],
              stayMins: 120,
              costJPY: 0,
            },
            {
              id: 'd3-takachiho',
              time: '11:00',
              kind: 'spot',
              level: 'must',
              title: 'é«˜åƒç©‚å³¡ï¼šåˆ’èˆ¹ (Takachiho Gorge Boat)',
              titleLocal: 'é«˜åƒç©‚å³¡ è²¸ã—ãƒœãƒ¼ãƒˆ',
              desc: `é‡é»ä»»å‹™ï¼šå‹™å¿…äº‹å‰é ç´„ï¼ˆ2 é€±å‰ 09:00 é–‹æ”¾ï¼‰ã€‚
ç¾å ´å¯èƒ½ä»éœ€æ’éšŠ/ç­‰å€™ï¼Œè«‹é ç•™ç·©è¡ã€‚`,
              bestShot: 'åˆå',
              lens: '24mm æ‹å³½è°·å‚ç›´ç·šï¼›35mm æ‹èˆ¹ä¸Šè¦–è§’ã€‚
æ³¨æ„é˜²æ½‘æ°´ï¼šæº–å‚™æ‹­é¡å¸ƒèˆ‡ç°¡æ˜“é˜²é›¨ç½©ã€‚',
              mapsQuery: 'é«˜åƒç©‚å³¡ ç¬¬1å¾¡å¡©äº•é§è»Šå ´ è²¸ã—ãƒœãƒ¼ãƒˆ',
              links: [
                { label: 'è²¸ã—ãƒœãƒ¼ãƒˆèª¬æ˜', url: 'https://takachiho-kanko.info/boat/detail.php' },
                { label: 'è²¸ã—ãƒœãƒ¼ãƒˆäºˆç´„', url: 'https://eipro.jp/takachiho1/eventCalendars/index' }
              ],
              stayMins: 120,
              costJPY: 5200,
            },
            {
              id: 'd3-drive-back',
              time: '15:30',
              kind: 'drive',
              level: 'must',
              title: 'ç§»å‹•ï¼šé«˜åƒç©— â†’ åšå¤š',
              titleLocal: '',
              desc: 'å¤©é»‘å¾Œå±±è·¯æ³¨æ„å®‰å…¨ï¼›è‹¥å»¶èª¤ï¼Œæ™šé¤æ”¹ç°¡å–®ã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'åšå¤šé§…',
              links: [],
              stayMins: 220,
              costJPY: 0,
            },
            {
              id: 'd3-hotel',
              time: '20:00',
              kind: 'hotel',
              level: 'must',
              title: 'å…¥ä½ï¼šéƒ½ãƒ›ãƒ†ãƒ« åšå¤š (Miyako Hotel Hakata)',
              titleLocal: 'éƒ½ãƒ›ãƒ†ãƒ« åšå¤š',
              desc: 'å›åˆ°åšå¤šå¾Œå…ˆå…¥ä½ï¼›è‹¥é‚„æœ‰é«”åŠ›å†å‡ºå»åƒã€‚',
              bestShot: 'å¤œ',
              lens: 'å®¤å…§/å¤œæ™¯ï¼š35mmï¼›æ± ç•”ç·šæ¢ 24â€“35mmã€‚',
              mapsQuery: 'éƒ½ãƒ›ãƒ†ãƒ« åšå¤š',
              links: [{ label: 'å®˜æ–¹', url: 'https://www.miyakohotels.ne.jp/hakata/' }],
              stayMins: 30,
              costJPY: 0,
            },
            {
              id: 'd3-dinner',
              time: '20:45',
              kind: 'food',
              level: 'flex',
              title: 'æ™šé¤ï¼šåšå¤šç«™å‘¨é‚Šï¼ˆå£½å¸/ç‰›è…¸é‹æ“‡ä¸€ï¼‰',
              titleLocal: 'å¯¿å¸ / ã‚‚ã¤é‹',
              desc: 'é€™æ™šä»¥ã€Œå¥½æŠµé”ã€ç‚ºæº–å‰‡ï¼›å¯æŠŠæƒ³åƒçš„ omakase å¡«é€²é¤å»³è³‡è¨Šã€‚',
              bestShot: '',
              lens: 'é£Ÿç‰©ï¼š35mm / 50mmï¼›æ¡Œé¢æš—ï¼Œå¿«é–€ 1/60 ä»¥ä¸Šã€‚',
              mapsQuery: 'åšå¤šé§… å¯¿å¸ ãŠã¾ã‹ã›',
              links: [],
              stayMins: 90,
              costJPY: 12000,
              food: {
                name: 'ï¼ˆå¾…å¡«ï¼‰',
                nameLocal: '',
                tabelogScore: '',
                tabelogUrl: '',
                reserve: { tablecheck:'', hotpepper:'', omakase:'', official:'' },
                note: 'æŠŠä½ æŒ‘å¥½çš„åšå¤š omakaseï¼ˆåº—å/é£Ÿã¹ãƒ­ã‚°/è¨‚ä½ï¼‰è²¼é€²ä¾†å³å¯ã€‚'
              }
            },
          ]
        },
        {
          id: 'day4',
          dayLabel: 'Day 4',
          date: '2026/03/28ï¼ˆå…­ï¼‰',
          area: 'ç¦å²¡ï¼ˆå¤ªå®°åºœï¼‰â†’ ç¦å²¡ç©ºæ¸¯ â†’ æ™šç­å›å°',
          title: 'å¤ªå®°åºœ Â· è³¦æ­¸',
          summary: 'ä¸Šåˆå¤ªå®°åºœï¼Œåˆå¾Œå›å¸‚å€/æ©Ÿå ´ï¼›ä¿ç•™å¡è»Šèˆ‡é‚„è»Šç·©è¡ã€‚',
          driveHint: 'å¸‚å€â†’æ©Ÿå ´ï¼ˆä¿ç•™ç·©è¡ï¼‰',
          base: { name: 'ç¦å²¡å¸‚å€ï¼ˆåšå¤šï¼‰', lat: 33.5896534, lon: 130.4228213 },
          stops: [
            {
              id: 'd4-dazaifu',
              time: '08:30',
              kind: 'spot',
              level: 'must',
              title: 'å¤ªå®°åºœå¤©æº€å®® (Dazaifu TenmangÅ«)',
              titleLocal: 'å¤ªå®°åºœå¤©æº€å®®',
              desc: 'æ—©ä¸Šå»æœ€çœäººæ½®ï¼›åƒé“æ‹æ”ç”¨ä¸­ç„¦å£“ç¸®äººæµã€‚',
              bestShot: 'æ™¨',
              lens: '35mm èµ°æ‹ï¼›70mm å£“ç¸®åƒé“å±¤æ¬¡ã€‚',
              mapsQuery: 'å¤ªå®°åºœå¤©æº€å®®',
              links: [{ label:'å®˜æ–¹', url:'https://www.dazaifutenmangu.or.jp/' }],
              stayMins: 90,
              costJPY: 0,
            },
            {
              id: 'd4-airport',
              time: '16:30',
              kind: 'drive',
              level: 'must',
              title: 'ç¦å²¡ç©ºæ¸¯é‚„è»Š â†’ æ™šç­å›å°',
              titleLocal: 'ç¦å²¡ç©ºæ¸¯',
              desc: 'åŠ æ²¹ã€é‚„è»Šã€æ•´ç†è¡Œæã€‚èˆªç­æ™‚é–“å¯åœ¨ç·¨è¼¯æ¨¡å¼è£œä¸Šã€‚',
              bestShot: '',
              lens: '',
              mapsQuery: 'ç¦å²¡ç©ºæ¸¯ ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ è¿”å´',
              links: [],
              stayMins: 180,
              costJPY: 0,
            }
          ]
        }
      ]
    };

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    // URL-safe base64
    function b64UrlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }
    function b64UrlDecode(b64url){
      let b64 = b64url.replaceAll('-','+').replaceAll('_','/');
      while(b64.length % 4) b64 += '=';
      return decodeURIComponent(escape(atob(b64)));
    }

    createApp({
      data(){
        return {
          editMode: false,
          plan: deepClone(defaultPlan),
          doneMap: {},
          weatherDayIndex: 0,
          weather: { loading: false, error: '', items: [] },
          mapTileError: false,
          modals: {
            food: { open: false, di: -1, si: -1 },
            json: { open: false, mode: 'export', text: '' },
            stop: { open: false, di: -1, si: -1 }
          },
          foodForm: {
            name: '',
            nameLocal: '',
            tabelogScore: '',
            tabelogUrl: '',
            reserve: { tablecheck: '', hotpepper: '', omakase: '', official: '' },
            note: ''
          },
          stopMenu: { level: 'must', kind: 'spot', stayMins: '', costJPY: '' },
        }
      },
      computed: {
        selectedDay(){ return this.plan.days[this.weatherDayIndex] || this.plan.days[0] || {}; },
        hasCoords(){
          const d = this.selectedDay;
          return !!(d?.base?.lat && d?.base?.lon && Number.isFinite(Number(d.base.lat)) && Number.isFinite(Number(d.base.lon)));
        },
        mapTileUrls(){
          if(!this.hasCoords) return [];
          const z = 12;
          const { x, y, n } = this.latLonToTileXY(Number(this.selectedDay.base.lat), Number(this.selectedDay.base.lon), z);
          const x2 = (x + 1) % n;
          const y2 = Math.min(y + 1, n - 1);
          return [
            this.osmTileUrl(z, x, y),
            this.osmTileUrl(z, x2, y),
            this.osmTileUrl(z, x, y2),
            this.osmTileUrl(z, x2, y2),
          ];
        },
        totalStops(){
          const dayStops = this.plan.days.reduce((acc,d)=>acc + (d.stops?.length||0), 0);
          const taskStops = (this.plan.tasks?.length||0);
          return dayStops + taskStops;
        },
        doneCount(){
          return Object.values(this.doneMap).filter(Boolean).length;
        },
        progressPct(){
          if(!this.totalStops) return 0;
          return Math.round((this.doneCount / this.totalStops) * 100);
        },
        totalJPY(){
          let sum = 0;
          for(const d of this.plan.days){
            for(const s of (d.stops||[])) sum += Number(s.costJPY||0);
          }
          return Math.round(sum);
        },
        totalTWD(){
          return Math.round(this.totalJPY * EXCHANGE_RATE);
        }
      },
      mounted(){
        const bm = document.getElementById('bootMsg');
        if(bm) bm.style.display = 'none';

        this.loadFromHashOrLocal();
        this.loadDone();
        this.fetchWeather();
        window.addEventListener('hashchange', () => this.loadFromHashOrLocal());
      },
      methods: {
        // City preview helpers
        latLonToTileXY(lat, lon, z){
          const n = Math.pow(2, z);
          const xt = Math.floor((lon + 180) / 360 * n);
          const latRad = lat * Math.PI / 180;
          const yt = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
          const x = ((xt % n) + n) % n;
          const y = Math.min(Math.max(yt, 0), n - 1);
          return { x, y, n };
        },
        osmTileUrl(z, x, y){
          return `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
        },
        openStreetMapUrl(lat, lon, zoom=12){
          const la = Number(lat), lo = Number(lon);
          if(!Number.isFinite(la) || !Number.isFinite(lo)) return 'https://www.openstreetmap.org';
          return `https://www.openstreetmap.org/?mlat=${encodeURIComponent(la)}&mlon=${encodeURIComponent(lo)}#map=${encodeURIComponent(zoom)}/${encodeURIComponent(la)}/${encodeURIComponent(lo)}`;
        },
        googleMapsLatLonUrl(lat, lon){
          const la = Number(lat), lo = Number(lon);
          if(!Number.isFinite(la) || !Number.isFinite(lo)) return 'https://www.google.com/maps';
          return `https://www.google.com/maps?q=${encodeURIComponent(la+','+lo)}`;
        },
        onWeatherDayChange(){
          this.mapTileError = false;
          this.fetchWeather();
        },
        refreshWeather(){
          this.mapTileError = false;
          this.fetchWeather();
        },

        // --- Badges ---
        kindText(kind){
          return ({ spot:'æ™¯é»', food:'é¤å»³', hotel:'ä½å®¿', drive:'ç§»å‹•', task:'ä»»å‹™' }[kind]) || kind;
        },
        levelText(level){
          return ({ must:'å¿…å»', flex:'å¯èª¿æ•´', backup:'å‚™æ¡ˆ' }[level]) || level;
        },
        kindBadge(kind){
          return ({
            spot: 'border-stone-300 bg-white text-stone-700',
            food: 'border-stone-300 bg-white text-stone-700',
            hotel:'border-stone-300 bg-white text-stone-700',
            drive:'border-stone-300 bg-white text-stone-700',
            task:'border-stone-300 bg-white text-stone-700',
          }[kind]) || 'border-stone-300 bg-white text-stone-700';
        },
        levelBadge(level){
          return ({
            must: 'border-stone-700 bg-stone-800 text-stone-50',
            flex: 'border-stone-300 bg-white text-stone-700',
            backup: 'border-stone-300 bg-stone-100 text-stone-700',
          }[level]) || 'border-stone-300 bg-white text-stone-700';
        },

        // --- Editable helpers ---
        toggleEdit(){ this.editMode = !this.editMode; },
        onBlurText(evt, path){
          if(!this.editMode) return;
          const value = (evt.target.innerText ?? '').trimEnd();
          this.setByPath(path, value);
          this.persist();
        },
        setByPath(path, value){
          const segs = path.split('.');
          let cur = this.plan;
          for(let i=0;i<segs.length-1;i++){
            const k = segs[i];
            cur = cur[k];
            if(cur === undefined || cur === null) return;
          }
          cur[segs[segs.length-1]] = value;
        },

        // --- Done state ---
        doneKey(dayId, stopId){ return `${dayId}::${stopId}`; },
        loadDone(){
          try{
            const raw = localStorage.getItem(LS_DONE_KEY);
            this.doneMap = raw ? JSON.parse(raw) : {};
          }catch(_){ this.doneMap = {}; }
        },
        saveDone(){
          try{ localStorage.setItem(LS_DONE_KEY, JSON.stringify(this.doneMap)); }catch(_){ }
        },
        isDone(dayId, stopId){ return !!this.doneMap[this.doneKey(dayId, stopId)]; },
        toggleDone(dayId, stopId){
          const k = this.doneKey(dayId, stopId);
          this.doneMap[k] = !this.doneMap[k];
          this.saveDone();
        },
        resetDone(){ this.doneMap = {}; this.saveDone(); },

        // --- Weather ---
        weatherCodeToText(code){
          if(code === 0) return 'æ™´';
          if([1,2,3].includes(code)) return 'å¤šé›²';
          if([45,48].includes(code)) return 'éœ§';
          if([51,53,55,56,57].includes(code)) return 'æ¯›æ¯›é›¨';
          if([61,63,65,66,67].includes(code)) return 'é›¨';
          if([71,73,75,77].includes(code)) return 'é›ª';
          if([80,81,82].includes(code)) return 'é™£é›¨';
          if([95,96,99].includes(code)) return 'é›·é›¨';
          return 'ä¸æ˜';
        },
        async fetchWeather(){
          const d = this.selectedDay;
          if(!d?.base?.lat || !d?.base?.lon) return;
          this.weather.loading = true;
          this.weather.error = '';
          try{
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(d.base.lat)}&longitude=${encodeURIComponent(d.base.lon)}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FTokyo`;
            const res = await fetch(url);
            if(!res.ok) throw new Error('weather fetch failed');
            const json = await res.json();
            const dates = json.daily?.time || [];
            const code = json.daily?.weathercode || [];
            const tmax = json.daily?.temperature_2m_max || [];
            const tmin = json.daily?.temperature_2m_min || [];
            const p = json.daily?.precipitation_sum || [];
            this.weather.items = dates.slice(0,5).map((dt, i) => ({
              date: dt,
              text: this.weatherCodeToText(code[i]),
              tmax: Math.round(tmax[i] ?? 0),
              tmin: Math.round(tmin[i] ?? 0),
              precip: Math.round((p[i] ?? 0) * 10) / 10,
            }));
          }catch(_){
            this.weather.error = 'å¤©æ°£è®€å–å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯/é˜»æ“‹è·¨åŸŸï¼‰ã€‚';
          }finally{
            this.weather.loading = false;
          }
        },

        // --- Maps ---
        mapsSearchUrl(q){
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
        },
        openGoogleMapsDay(day){
          const points = [];
          if(day.base?.name) points.push(day.base.name);
          for(const s of (day.stops||[])) if(s.mapsQuery) points.push(s.mapsQuery);
          if(points.length < 2){
            window.open(this.mapsSearchUrl(day.base?.name || day.area), '_blank', 'noreferrer');
            return;
          }
          const origin = points[0];
          const destination = points[points.length-1];
          const waypoints = points.slice(1, -1).join('|');
          const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=driving&waypoints=${encodeURIComponent(waypoints)}`;
          window.open(url, '_blank', 'noreferrer');
        },

        // --- Food editor ---
        openFoodEditor(di, si){
          const stop = this.plan.days[di].stops[si];
          if(!stop.food){
            stop.food = { name:'', nameLocal:'', tabelogScore:'', tabelogUrl:'', reserve:{tablecheck:'',hotpepper:'',omakase:'',official:''}, note:'' };
          }
          this.modals.food = { open:true, di, si };
          this.foodForm = JSON.parse(JSON.stringify(stop.food));
        },
        closeFoodEditor(){ this.modals.food.open = false; },
        saveFood(){
          const { di, si } = this.modals.food;
          if(di<0 || si<0) return;
          const stop = this.plan.days[di].stops[si];
          stop.food = JSON.parse(JSON.stringify(this.foodForm));
          this.persist();
          this.closeFoodEditor();
        },

        // --- Stop menu ---
        openStopMenu(di, si){
          const stop = this.plan.days[di].stops[si];
          this.modals.stop = { open:true, di, si };
          this.stopMenu = {
            level: stop.level || 'must',
            kind: stop.kind || 'spot',
            stayMins: stop.stayMins ? String(stop.stayMins) : '',
            costJPY: stop.costJPY ? String(stop.costJPY) : '',
          };
        },
        closeStopMenu(){ this.modals.stop.open = false; },
        applyStopMenu(){
          const { di, si } = this.modals.stop;
          const stop = this.plan.days[di].stops[si];
          stop.level = this.stopMenu.level;
          stop.kind = this.stopMenu.kind;
          stop.stayMins = this.stopMenu.stayMins ? Number(this.stopMenu.stayMins) : 0;
          stop.costJPY = this.stopMenu.costJPY ? Number(this.stopMenu.costJPY) : 0;
          this.persist();
          this.closeStopMenu();
        },

        // --- JSON import/export ---
        openJson(mode){
          this.modals.json.open = true;
          this.modals.json.mode = mode;
          this.modals.json.text = mode === 'export' ? JSON.stringify(this.plan, null, 2) : '';
        },
        closeJson(){ this.modals.json.open = false; },
        importJson(){
          try{
            const obj = JSON.parse(this.modals.json.text);
            this.plan = obj;
            this.persist();
            this.weatherDayIndex = 0;
            this.mapTileError = false;
            this.fetchWeather();
            this.closeJson();
          }catch(_){
            alert('JSON æ ¼å¼éŒ¯èª¤');
          }
        },
        async copyText(text){
          try{ await navigator.clipboard.writeText(text); alert('å·²è¤‡è£½'); }
          catch(_){ alert('è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰ã€‚'); }
        },

        // --- Share (hash) ---
        setHashFromPlan(){
          try{
            const str = JSON.stringify(this.plan);
            const enc = b64UrlEncode(str);
            location.hash = `#p=${enc}`;
          }catch(_){ }
        },
        copyShare(){
          this.setHashFromPlan();
          const url = location.href;
          this.copyText(url);
        },

        // --- Persistence ---
        persist(){
          try{ localStorage.setItem(LS_KEY, JSON.stringify(this.plan)); }catch(_){ }
        },
        loadFromHashOrLocal(){
          const h = location.hash || '';
          const m = h.match(/#p=([^&]+)/);
          if(m && m[1]){
            try{
              const str = b64UrlDecode(m[1]);
              const obj = JSON.parse(str);
              this.plan = obj;
              this.persist();
              return;
            }catch(_){ }
          }
          try{
            const raw = localStorage.getItem(LS_KEY);
            this.plan = raw ? JSON.parse(raw) : deepClone(defaultPlan);
          }catch(_){
            this.plan = deepClone(defaultPlan);
          }
        },
        resetPlan(){
          if(!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è¡Œç¨‹ï¼Ÿï¼ˆæœƒè¦†è“‹ç›®å‰ä¿®æ”¹ï¼‰')) return;
          this.plan = deepClone(defaultPlan);
          this.persist();
          this.weatherDayIndex = 0;
          this.mapTileError = false;
          this.fetchWeather();
          history.replaceState(null, '', location.pathname + location.search);
        },

        // --- Tasks ---
        addTask(){
          this.plan.tasks.push({ id: `task-${Date.now()}`, title: 'æ–°ä»»å‹™', note: 'ï¼ˆé»ç·¨è¼¯å¾Œå¯ä¿®æ”¹ï¼‰' });
          this.persist();
        },
        deleteTask(i){
          if(!confirm('åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
          const t = this.plan.tasks[i];
          delete this.doneMap[this.doneKey('task', t.id)];
          this.plan.tasks.splice(i,1);
          this.persist();
          this.saveDone();
        },

        // --- Misc ---
        scrollTop(){ window.scrollTo({ top: 0, behavior: 'smooth' }); }
      }
    }).mount('#app');

    // hide boot message if mount succeeded
    try{ const bm = document.getElementById('bootMsg'); if(bm) bm.style.display='none'; }catch(_){ }
  </script>
</body>
</html>
