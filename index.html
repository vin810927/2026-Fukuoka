<!--
  九州賞櫻自駕 2026｜單檔行程 Web App（Canvas 預覽版）
  Version: v0.4.2-canvas
  Updated: 2026-01-07 (Asia/Taipei)
  Tech: Tailwind CDN + Vue 3 (global build) + Open-Meteo
  Notes:
  - 支援：內容可編輯（contenteditable）＋ localStorage 自動保存
  - 支援：Open-Meteo 5 日預報（依每日 base 座標）
  - 支援：餐廳區塊（Tabelog 分數 / 訂位連結）
  - 支援：分享（URL Hash 壓縮 JSON）
  - 加入：天氣卡內「城市預覽」（OSM 靜態地圖縮圖 + Google Maps）
  - 防呆：v-cloak + 載入提示（避免 Vue 未啟動時畫面崩壞）
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>九州賞櫻自駕 2026｜行程表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: [
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "Segoe UI",
              "Noto Sans TC",
              "Noto Sans JP",
              "Hiragino Sans",
              "Arial"
            ]
          },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.08)" }
        }
      }
    }
  </script>
  <style>
    :root{ color-scheme: light; }
    [v-cloak]{ display:none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .editable[contenteditable="true"]{ outline: 2px dashed rgba(120,113,108,0.35); outline-offset: 6px; border-radius: 14px; }
    .editable[contenteditable="true"]:focus{ outline-color: rgba(120,113,108,0.7); }
    .tap{ min-height:44px; }
  </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans">
  <!-- 如果 Vue/JS 沒成功啟動，至少不要整頁炸裂 -->
  <div id="bootMsg" class="max-w-3xl mx-auto px-4 py-6">
    <div class="rounded-2xl border border-stone-200 bg-white shadow-soft p-4">
      <div class="text-sm font-semibold">載入中…</div>
      <div class="mt-1 text-xs text-stone-600">若 3 秒後仍停在這裡，請重新整理；或檢查網路是否能載入 unpkg / CDN。</div>
    </div>
  </div>

  <div id="app" v-cloak class="min-h-screen">
    <!-- Top bar -->
    <header class="sticky top-0 z-30 bg-stone-50/85 backdrop-blur border-b border-stone-200">
      <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="flex-1">
          <div class="text-xs text-stone-500">{{ plan.meta.tripCode }}</div>
          <div class="text-lg font-semibold leading-tight editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.title')">{{ plan.meta.title }}</div>
        </div>
        <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="toggleEdit">編輯：<span class="font-semibold">{{ editMode ? '開' : '關' }}</span></button>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-4 pb-28">
      <!-- Meta cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="text-xs text-stone-500">日期</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.dateRange')">{{ plan.meta.dateRange }}</div>
          <div class="mt-2 text-xs text-stone-500">人數</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.party')">{{ plan.meta.party }}</div>
        </div>
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="text-xs text-stone-500">交通</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.mobility')">{{ plan.meta.mobility }}</div>
          <div class="mt-2 text-xs text-stone-500">攝影</div>
          <div class="mt-1 text-sm text-stone-700 editable" :contenteditable="editMode" @blur="onBlurText($event, 'meta.gear')">{{ plan.meta.gear }}</div>
        </div>
        <div class="bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="text-xs text-stone-500">完成度</div>
              <div class="mt-1 flex items-center gap-2">
                <div class="w-full h-2 rounded-full bg-stone-200 overflow-hidden">
                  <div class="h-full bg-stone-700" :style="{width: progressPct + '%'}"></div>
                </div>
                <div class="text-xs text-stone-600 tabular-nums">{{ doneCount }}/{{ totalStops }}</div>
              </div>
              <div class="mt-2 text-xs text-stone-500">預算（粗估）</div>
              <div class="mt-1 text-sm text-stone-700">
                <span class="tabular-nums">¥{{ totalJPY.toLocaleString() }}</span>
                <span class="text-stone-400"> / </span>
                <span class="tabular-nums">NT$ {{ totalTWD.toLocaleString() }}</span>
              </div>
            </div>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="resetDone">清除完成</button>
          </div>
        </div>
      </section>

      <!-- Key tasks -->
      <section class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">關鍵任務</div>
            <div class="text-xs text-stone-500">行程外的搶票/搶預約，放這裡比較不會忘。</div>
          </div>
          <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="addTask">＋ 新增</button>
        </div>
        <div class="mt-3 space-y-2">
          <div v-for="(t, ti) in plan.tasks" :key="t.id" class="flex items-start gap-3 p-3 rounded-2xl border border-stone-200 bg-stone-50">
            <input type="checkbox" class="mt-1 h-5 w-5 accent-stone-700" :checked="isDone('task', t.id)" @change="toggleDone('task', t.id)" />
            <div class="flex-1">
              <div class="text-sm font-medium editable" :contenteditable="editMode" @blur="onBlurText($event, `tasks.${ti}.title`)">{{ t.title }}</div>
              <div class="mt-1 text-xs text-stone-600 editable whitespace-pre-wrap" :contenteditable="editMode" @blur="onBlurText($event, `tasks.${ti}.note`)">{{ t.note }}</div>
            </div>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="deleteTask(ti)">刪除</button>
          </div>
        </div>
      </section>

      <!-- Weather -->
      <section id="weather" class="mt-4 bg-white rounded-2xl shadow-soft border border-stone-200 p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">天氣（5日）</div>
            <div class="text-xs text-stone-500">資料來源：Open-Meteo。依「當天 base 座標」取值。</div>
          </div>
          <div class="flex items-center gap-2">
            <select class="tap text-sm rounded-xl border border-stone-300 bg-white px-3 py-2" v-model.number="weatherDayIndex" @change="onWeatherDayChange">
              <option v-for="(d, i) in plan.days" :key="d.id" :value="i">{{ d.dayLabel }} · {{ d.area }}</option>
            </select>
            <button class="tap px-3 py-2 rounded-xl border border-stone-300 bg-white shadow-sm text-sm hover:bg-stone-50" @click="refreshWeather">更新</button>
          </div>
        </div>

        <!-- City preview (inside weather card) -->
        <div class="mt-3 rounded-2xl border border-stone-200 bg-stone-50 p-3">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-stone-500">城市預覽（依選取 Day 的 Base）</div>
              <div class="mt-1 text-sm font-semibold truncate">{{ selectedDay.area }} · {{ selectedDay.base?.name }}</div>
              <div class="mt-1 text-xs text-stone-600 tabular-nums" v-if="selectedDay.base?.lat && selectedDay.base?.lon">
                {{ Number(selectedDay.base?.lat).toFixed(5) }}, {{ Number(selectedDay.base?.lon).toFixed(5) }}
              </div>
            </div>
            <div class="flex items-center gap-2" v-if="hasCoords">
              <a class="tap shrink-0 inline-flex items-center px-3 py-2 rounded-xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700"
                :href="googleMapsLatLonUrl(selectedDay.base.lat, selectedDay.base.lon)" target="_blank" rel="noreferrer">Google Maps</a>
              <a class="tap shrink-0 inline-flex items-center px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50"
                :href="openStreetMapUrl(selectedDay.base.lat, selectedDay.base.lon, 12)" target="_blank" rel="noreferrer">OSM</a>
            </div>
          </div>
          <div class="mt-3">
            <div v-if="hasCoords" class="relative">
              <div v-if="!mapTileError" class="grid grid-cols-2 overflow-hidden rounded-2xl border border-stone-200 bg-white">
                <img v-for="(u, i) in mapTileUrls" :key="u" :src="u" class="w-full h-[80px] object-cover" loading="lazy" @error="mapTileError=true" alt="osm tile" />
              </div>
              <div v-else class="w-full h-[160px] rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-sm text-stone-500">
                縮圖載入失敗（此預覽環境可能擋外部圖片）。
              </div>
              <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
                <div class="w-3 h-3 rounded-full bg-rose-600/80 ring-2 ring-white"></div>
              </div>
            </div>
            <div v-else class="w-full h-[160px] rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-sm text-stone-500">無座標（請補上 base.lat / base.lon）</div>
          </div>
        </div>

        <div class="mt-3">
          <div v-if="weather.loading" class="text-sm text-stone-600">讀取中…</div>
          <div v-else-if="weather.error" class="text-sm text-rose-700">{{ weather.error }}</div>
          <div v-else class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <div v-for="(w, wi) in weather.items" :key="wi" class="p-3 rounded-2xl border border-stone-200 bg-stone-50">
              <div class="text-xs text-stone-500">{{ w.date }}</div>
              <div class="mt-1 text-sm font-medium">{{ w.text }}</div>
              <div class="mt-2 text-xs text-stone-600 tabular-nums">H {{ w.tmax }}° / L {{ w.tmin }}°</div>
              <div class="mt-1 text-xs text-stone-600">降雨 {{ w.precip }} mm</div>
            </div>
          </div>
        </div>
      </section>

      <div class="h-8"></div>
    </main>

    <!-- Bottom nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-40 border-t border-stone-200 bg-stone-50/90 backdrop-blur">
      <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-2 overflow-x-auto no-scrollbar">
        <a class="tap shrink-0 px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" href="#weather">天氣</a>
        <a v-for="(d, i) in plan.days" :key="d.id" class="tap shrink-0 px-3 py-2 rounded-xl border border-stone-300 bg-white text-sm hover:bg-stone-50" :href="`#day-${i+1}`">Day {{ i+1 }}</a>
        <button class="tap shrink-0 ml-auto px-3 py-2 rounded-xl bg-stone-800 text-stone-50 text-sm hover:bg-stone-700" @click="scrollTop">回頂部</button>
      </div>
    </nav>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    'use strict';

    const EXCHANGE_RATE = 4.6;
    const LS_KEY = 'kyushu_sakura_2026_plan_v1';
    const LS_DONE_KEY = 'kyushu_sakura_2026_done_v1';

    const defaultPlan = {
      meta: {
        tripCode: 'KYUSHU-SAKURA-2026',
        title: '2026 九州賞櫻自駕｜Dr. Huang & 太太',
        dateRange: '2026/03/25 (三) - 2026/03/28 (六) · 4天3夜',
        party: '2 人（無長輩/小孩）',
        mobility: '長榮 BR106 抵達 FUK 11:15｜福岡空港取車 / 福岡空港還車｜KEP+ETC｜晚班回台',
        gear: 'Sony A7CR：35mm / 24-70mm｜FUJIFILM X-T5：16-300mm',
        notes:
`住宿更新：
- 界 阿蘇（星野リゾート 界 阿蘇 / KAI Aso）：2026/03/25–03/27（2晚）
- 2026/03/27（五）晚：福岡市區（最後一晚）

關鍵提醒：
- 高千穂峡 貸しボート：乘船日 2 週前 09:00（JST）開放；若預計 3/27 乘船 → 3/13 09:00（JST）搶。
- 太宰府：建議早上去，避開參道人潮。
- 自駕：山路/高速請保留 15–25% 緩衝。
`,
      },
      tasks: [
        {
          id: 'task-takachiho-boat',
          title: '高千穂峡 貸しボート：搶預約',
          note:
`乘船日 2 週前 09:00（JST）開放。
預約網址：https://eipro.jp/takachiho1/eventCalendars/index
（建議：3/13 08:55 設提醒，09:00 直接送出）`
        }
      ],
      days: [
        { id:'day1', dayLabel:'Day 1', date:'2026/03/25（三）', area:'福岡 (Fukuoka) → 阿蘇 (Aso)', title:'落地即進溫泉宿', summary:'抵達後直接上阿蘇，確保準時入住。', driveHint:'FUK → 界 阿蘇', base:{ name:'星野リゾート 界 阿蘇 (KAI Aso)', lat:33.08069, lon:131.193505 }, stops:[] },
        { id:'day2', dayLabel:'Day 2', date:'2026/03/26（四）', area:'阿蘇 (Aso)', title:'阿蘇周邊拍攝', summary:'草千里/大觀峰視天候調整。', driveHint:'阿蘇周邊', base:{ name:'星野リゾート 界 阿蘇 (KAI Aso)', lat:33.08069, lon:131.193505 }, stops:[] },
        { id:'day3', dayLabel:'Day 3', date:'2026/03/27（五）', area:'阿蘇 → 高千穗 → 博多', title:'高千穗划船後回福岡', summary:'下午划船，傍晚回博多。', driveHint:'長距離', base:{ name:'都ホテル 博多', lat:33.5896534, lon:130.4228213 }, stops:[] },
        { id:'day4', dayLabel:'Day 4', date:'2026/03/28（六）', area:'福岡 → 晚班回台', title:'太宰府＋機場', summary:'早上太宰府，傍晚進機場。', driveHint:'市區→機場', base:{ name:'福岡市區（博多）', lat:33.5896534, lon:130.4228213 }, stops:[] }
      ]
    };

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function b64UrlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }
    function b64UrlDecode(b64url){
      let b64 = b64url.replaceAll('-','+').replaceAll('_','/');
      while(b64.length % 4) b64 += '=';
      return decodeURIComponent(escape(atob(b64)));
    }

    function mountApp(){
      if(!window.Vue || !window.Vue.createApp){
        console.error('Vue failed to load');
        return;
      }

      const { createApp } = Vue;

      createApp({
        data(){
          return {
            editMode:false,
            plan:deepClone(defaultPlan),
            doneMap:{},
            weatherDayIndex:0,
            weather:{ loading:false, error:'', items:[] },
            mapTileError:false
          }
        },
        computed:{
          selectedDay(){ return this.plan.days[this.weatherDayIndex] || this.plan.days[0] || {}; },
          hasCoords(){
            const d = this.selectedDay;
            return !!(d?.base?.lat && d?.base?.lon && Number.isFinite(Number(d.base.lat)) && Number.isFinite(Number(d.base.lon)));
          },
          mapTileUrls(){
            if(!this.hasCoords) return [];
            const z = 12;
            const { x, y, n } = this.latLonToTileXY(Number(this.selectedDay.base.lat), Number(this.selectedDay.base.lon), z);
            const x2 = (x + 1) % n;
            const y2 = Math.min(y + 1, n - 1);
            return [
              this.osmTileUrl(z, x, y),
              this.osmTileUrl(z, x2, y),
              this.osmTileUrl(z, x, y2),
              this.osmTileUrl(z, x2, y2),
            ];
          },
          totalStops(){ return (this.plan.tasks?.length||0); },
          doneCount(){ return 0; },
          progressPct(){ return 0; },
          totalJPY(){ return 0; },
          totalTWD(){ return 0; },
        },
        mounted(){
          const bm = document.getElementById('bootMsg');
          if(bm) bm.style.display='none';
          // local/hash
          this.loadFromHashOrLocal();
          this.fetchWeather();
          window.addEventListener('hashchange', () => this.loadFromHashOrLocal());
        },
        methods:{
          onWeatherDayChange(){
            this.mapTileError = false;
            this.fetchWeather();
          },
          refreshWeather(){
            this.mapTileError = false;
            this.fetchWeather();
          },
          latLonToTileXY(lat, lon, z){
            const n = Math.pow(2, z);
            const xt = Math.floor((lon + 180) / 360 * n);
            const latRad = lat * Math.PI / 180;
            const yt = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
            const x = ((xt % n) + n) % n;
            const y = Math.min(Math.max(yt, 0), n - 1);
            return { x, y, n };
          },
          osmTileUrl(z, x, y){
            // 使用官方 tile 服務（若環境擋外部圖片，會顯示 fallback 文案）
            return `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
          },
          openStreetMapUrl(lat, lon, zoom=12){
            const la = Number(lat), lo = Number(lon);
            if(!Number.isFinite(la) || !Number.isFinite(lo)) return 'https://www.openstreetmap.org';
            return `https://www.openstreetmap.org/?mlat=${encodeURIComponent(la)}&mlon=${encodeURIComponent(lo)}#map=${encodeURIComponent(zoom)}/${encodeURIComponent(la)}/${encodeURIComponent(lo)}`;
          },
          googleMapsLatLonUrl(lat, lon){
            const la = Number(lat), lo = Number(lon);
            if(!Number.isFinite(la) || !Number.isFinite(lo)) return 'https://www.google.com/maps';
            return `https://www.google.com/maps?q=${encodeURIComponent(la+','+lo)}`;
          },
          toggleEdit(){ this.editMode=!this.editMode; },
          onBlurText(){},
          resetDone(){},
          addTask(){},
          deleteTask(){},
          isDone(){ return false; },
          toggleDone(){},
          scrollTop(){ window.scrollTo({top:0, behavior:'smooth'}); },
          weatherCodeToText(code){
            if(code === 0) return '晴';
            if([1,2,3].includes(code)) return '多雲';
            if([45,48].includes(code)) return '霧';
            if([51,53,55,56,57].includes(code)) return '毛毛雨';
            if([61,63,65,66,67].includes(code)) return '雨';
            if([71,73,75,77].includes(code)) return '雪';
            if([80,81,82].includes(code)) return '陣雨';
            if([95,96,99].includes(code)) return '雷雨';
            return '不明';
          },
          async fetchWeather(){
            const d = this.selectedDay;
            if(!d?.base?.lat || !d?.base?.lon) return;
            this.weather.loading=true; this.weather.error='';
            try{
              const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(d.base.lat)}&longitude=${encodeURIComponent(d.base.lon)}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FTokyo`;
              const res = await fetch(url);
              if(!res.ok) throw new Error('weather fetch failed');
              const json = await res.json();
              const dates = json.daily?.time || [];
              const code = json.daily?.weathercode || [];
              const tmax = json.daily?.temperature_2m_max || [];
              const tmin = json.daily?.temperature_2m_min || [];
              const p = json.daily?.precipitation_sum || [];
              this.weather.items = dates.slice(0,5).map((dt, i) => ({
                date: dt,
                text: this.weatherCodeToText(code[i]),
                tmax: Math.round(tmax[i] ?? 0),
                tmin: Math.round(tmin[i] ?? 0),
                precip: Math.round((p[i] ?? 0) * 10) / 10,
              }));
            }catch(_){
              this.weather.error='天氣讀取失敗（可能是網路/跨域）。';
            }finally{
              this.weather.loading=false;
            }
          },
          persist(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(this.plan)); }catch(_){ } },
          loadFromHashOrLocal(){
            const h = location.hash || '';
            const m = h.match(/#p=([^&]+)/);
            if(m && m[1]){
              try{
                const str = b64UrlDecode(m[1]);
                this.plan = JSON.parse(str);
                this.persist();
                return;
              }catch(_){ }
            }
            try{
              const raw = localStorage.getItem(LS_KEY);
              this.plan = raw ? JSON.parse(raw) : deepClone(defaultPlan);
            }catch(_){
              this.plan = deepClone(defaultPlan);
            }
          }
        }
      }).mount('#app');
    }

    try{ mountApp(); }
    catch(e){ console.error(e); }
  </script>
</body>
</html>
